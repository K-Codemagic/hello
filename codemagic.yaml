workflows:
  android-workflow:
    name: Android Cordova workflow
    environment:
      vars:
        KEYSTORE: Encrypted(Z0FBQUFBQmhLUFlXdkVqdkFFSU9rVlZ5czRxdzc3NC1TWWxmSGJSaVZSLU9kS0lySUFoRWxtbWQ1ZkVRVjRGX2MwempOeG5HNndHV2hUSjlxODVsR25FY09tbzJUaTg1dTcxOTJRNXZuZ0ZKbXppbmtoSEp6QTYzd2tUY2w1R0JFT1B0OGRhb2VDN2VzUU81WEFLejFOckZ0OU1oclB6M3l0U0xnWTVkcnBxbGVvNlpMaU0yTjV5RWFrTVRpZVVpTU1vd3VBT0xKYXFfbVcyWFBuMTF4eVZyN3JKczZZcV9JSkM0aTFJYXhSc0lTRDE2WUo0ZTRsX1R3bWlOT1VudHVEMkdQMjNyUllVZGZZNmlYS3FWWTRKWVdmcDdYX0FsRXZTU0tLUW1hLUpSbk5CbzNwdmVpdHNXakZsLTlRQm16b0hLam9oeGQwVG1zUUNKbkJ4QzM3UTJnSXdJMkQ2bzgxM1JkcG5TNDBKb25SNElsMjY1R2JUUW9QdXBXU1RYYnJOaVZOQjhxNUJiXzZPaGFnT19aTXhJR2xhRGVRUWluclJBR0NTcl8xdGx3TEwyb19WN1ZuT2FyWmIxRUZ5aGJLbEp6b25QWklwRmlZZzhFdXlhSmNvWUVaX0NLX2FVRExMQXVpY1BoS1FReDFURTdlU0hYbVR6TEtobnBMQjJENVZSUzRuSmQweEhrZjZqazA3WGZ5YjVKaHNHbUhlUFo4cl91WXNseUZ0MDZ6Z24yR3V5a2hScGRyMFY3aHlzWmxCRVJLUVJaMDdpeUtaak5scEFGRlZ2QUpOb21lWG95cy11RHFQeF9Id0xuX1FTVmJyNXZZUWY3YlpmUjNycVpxVDhPemVCWlE3LS1xamZXaFVFMTdzeW15djhWamJLTkg5U0IwVUlFVXo1ZnpMbHNkcWJjQ3dxNmlDYUI4aTdiQzJPMG42anlwVnB0SndETzZQLUhveVJfb2dabGlmVE9NaklkNk1ZLVJDQjZIbGd4T3VocWNtZ3pyUlFINWZMeDZ5UXdBY0NUNWhHTkdpOVhVbjdHUk11NldEZUtOV0dSeTVCUFlIWmdxc3gyX3FuNGRENDNIZ2pUY0xTOEJsOVZBUEg1LS1IZU1nREJzU2RHQVNKQWNRbVdKUVBKTzU5eUtHLWVVOTVtWllNVm9LREdXYmR3UE53YzJ5aGQ4OTJyTFBqcXlZdWEwM25vY0Y2b0I4SFJrUmtUX3ExajRraWdnUExZc213a2RqTkgyMWZNSUdfZG4wZzl4ekdVNmVLVEFtV1o4N1h6elVjcUc4bnViQ2NhQk1jWkl6XzB6c0t2eHpfb0NPYW1KSGMtNE5LYVMwMS1NS0MwT0VnUjQ4Mk9HNmtkRjNneE5MZVV5N2YycEs5WWFRX2NlcDA2WEdyZEQyV2VWaFg4Z0RQc3F1amVMRHZwVzh2b0VoeHJtcThyQ1Z0STRucWREM0ZUZENjb3E1LUVXZkRpYzYyQ0pWakFLYWdxNEJRVlo2NTlTLVFFUWVBWlFXWDNyRmNZWW9RLUtlZ1dsTS1CMEFJc2FQNUctS29vZVhfYXhMTzBqZmFFQU54VERIX1Q4bDFRbk1ETDFVcU9famNkcU5EUlJOUV9kRzdtWDJCNjZCUGd3Q1poOFJtWlMtOGR3SE11LXQ2al9RQXJOR3ZyYmUyTXE1X3ZUeUw5MUFoNXV0MlBCYzlzSmhsb3FCNlZxZWc5N2xCNzlyUnYwaEdmdWNfMGhQZXZ0c2x1RzJlbVRxNGV6bXlaMVByanVlRTRzT0RGOHJnaDVCbWhIcGc1dzBzTGpyZU5RQnRRR0UxY2RnRWRxQWFScnZLb0FrdWNuT3FUNGpKNnRoblJNTnBFZGZ6NUxsbG1Ka2c3Z1RRN3NOSDlpdGdicmUtLTg2aDhxVUU1WVVkY0V3OHdRdjk4SjNTSTNSVTFEQzF5VXJLU0ltUlFva2lmWjV0RTdWUjlXT2hVdnRqcHBEZGZOMVFXLXBZclJsUHN4T2NjV2kxbU00SFhCWkZFeTFEanVFdElqTUwzT0dESzVqWUNfWWhfNF9sSW1XRXh0T2xYd25ucFFOUWJobTRIcGU3U2xSWDRlSUhxakJHZHB4eWxROXl4bl9nNVNDT0lSUlpJdy1TM0F5c01GeDR6RjI2MFV1UGZjU2RoRG8yMmtQLTF6dTJNSG1oR2dLX3FFVjJQV1NIbnFVTHBnZF9Va1dfZDR0S2VmNUt2UmF5ZUd6d0xIcnJMc0pBQW9LZ1BobDJjMnRJbjNCQTFqaVoxV2NWM0thbnBJeHViWlF2SnlzYUVSMTQxY28zRlhRWHlFa3NNMEtKTG9XbDFMUjVEYlp1S2RrSkVpeDYycUYyWVYyT0NILUttU3lwalZobllPMXFyTERab3UtTWdWdjNQcW9hVkF4b2ZScUZzdGdlZzNURHNqRzZUMUNWcEV0WXdtb1loNXNVd1Z3U2xJX3hQSnYwaWJnX25mNi1PM19HeGc4SjFTS2dVcUdWVGtJTmJyX3EyRDBiQWR1MnJ6V28tT3pVN0RleVlWMVZTRkFpUXYyY1d3SzFoM0RGaDM5M05NZ21yQnBQSlRYejgxa1U4ZnRocnNEZHJCMzlvSV9CdXF2ZW04WlhzdTNpdTBuRnNMZUxMLVQ0NEVhTko4NTJxMWRwdlM2SUEwUlNEZEhFNzhlWWNJVTRCeGhhaUJpeWpzLTg3a2sxd2FzWHdyVGVMMWpxTy1tLWdraDVrVVgyRl82VUxKNC1QeW1xZW96RG5Qc2wyNGEtRmU5UFAtZkVHNHNwNlBrLXI0U2FJX25vWmR5anc0X3dSRTVJb2dlWVU1VHZoS2xFR1JfNUlSUkozeGdiakk2WGZSS1A5VHh3dFdfdUotZk1mOFFfXzZLdlpwR052b1dYN3BvYnVhYmttT3RlMk95VlQwbENLSFhzeFFvUWFXTU5PRWNOZ3FpR3lhR01hT0hoLWZRdEl0MEhqMm9fQTdjTWZ5RTk1Z3VwOHc3LXFwTnZScUhoY05ISmJJWE1CVTljZzg4Y2kyaFdhMXR6V3EyeVRrcGRFSlN1aUFScGRLLVhYcmljSkNtZEJQanBBamZySGp0dzM4VFFBbHVVODd4UlFickRSRTB2cW5JODBjTkYyYS1VdW5VamRZMVJLRlBrR01KQlI2S3FEeHAzTGlkV1BnWnN1ZXhZbVlacEt0eDlzX1YyOUlRUUptLWpYLVUwRm1pQURwbmtGZGZKRVBFSXFDcngyMFhNVGhyejdlMW1jUXNsbi0ySDM5VlBaSHdBcUdNRjFxUWRWLVcwd0sxeTNTd3NJRFNUUzh5SHM3MnBRX2FQUnpOZFNkd2JJYW9aUHA2ajQ5V0JJck5kMDhOZDFNcVVvZFB3MGxqdnd2NUdjZlA4M3FRSnpuRC1LUWoxbG5BOHg3ZjBub3lFNFJ1WHNlNHRsSGhQRXQyZHloazZ1M2lLMktFYVBhRUl6LURVdURWNnRGRmNRTmw4cXZwdFlGbWhCbURneC01VkpxakdhNEZfeVFIZTNScjd6WXRXT04wdnRwa2dPcnQ5a2Zrb1lTNy15X21qdDRzLWR5ZHUxcjh5bVhyREdNcEVPZ3JnV19tLTc5OFl4REQtWHhmTmJwdHFpUU1IN3lfclJZc1VwWTVva3pKUll4MWNKMEJvdTFkWDFMN3JKLWJuNllON0RpSWkzV090WlNWRi16MThxbEJWeHZ5ZFN0MXRtNDNIWWJLU0lxUWhvNHpUZW9ZWUtaYmY0Y2NWSU9CejlYdzFqRUVCRFA4blhVWkMxRFpVcmZ5cDdETnBvajhsOXJaQ0UtTlFXRTdkM1JqVGN0d3FWWFVYODF5UXR3ZkYxUkVlZE5jaXdlZGJqb09xZ2Q1U1EyV1RDT3dMYUR5Q3JlZllMTGUxR3dkeERuck84MFJjZFFTbWJDTkxLWGhBeW8tZWFqc1ZQZVoxM1VSRHhyM1A0VkpfTGo0endYYzFzMDRGR05Pb2FFMkxWdVpWbFJ2alFRNFhoa2ZadEV0dWdyMEdwVVZNcTNtRWhBR3Etd3E0dG5QelR1Ykd4UF81eExac1ZlUUx3SlQyZVF2bVVORVdtMlZHQlZadTRlUHhoWGdvaDhWcm5vXy1HNWZkcEg5eTJ4MmVRcTVzX1Y4cGdXUVctajd1cHhCYW9mVUxDSVFLb3NTeDVFLTF5SHN6UnRHU2lFYS1heC0zMXpRRGx1akJsMUZBY2xndFpUbjNYNzU0U0JoRGJkY0cxblZoNWhocm01U0NuTXp0ZE5nM0k3T01qX1hrU3pZSUdXM2FnYWE3REUyWlBHZmVFdVJwMUVoejRvQ3YzVTVsZGlUSFl0NjhLRGd2TnVnRkxhdXktSjlFRktuczVYZTE2ckcyVzBkOTRCMXZVbmpPc0VpU0ZmSWpkdGhTMWcybU8tdHc0cHJISlFqLWppam5FNTJiVGpDVWFUVExGUkpHLUdfVTBmeVVQaUpQRzhJZHVpSTAyR1RFZ2g4SlNlMWRWeV9oWG5Dc29HZnZlcEx2dmRmLTd5blhic1RmRVg0VENXY09zdkpMNWV6WG42eTFKWFpWVlpoaVFqRTZiRHhub0RvaGRkeUVrM0FsYV9KOUVHLXFEdUwzUVR4RkZUOUFveUxlcnNwTkpLWUVVZTZidEFkRnZuUGlLQ25yUm9HM3pheXBJSGo5cUdZckdKRGVhLTR3alpBOVM2dlJWOGZVS2pSR0l3MlE0YVhPUGE5ckp0d1dQRTBiLXl6dEZmaERuMEluODlOeFp6UVpsNVVEWm9SQTh6QXo4SFhCREk0UG94aHJVYnlHX3I4bXJQZElJci1veU5JXzNqaHI2ZEVjRTlOWVFyR1NFUVNiVU5pYlZUdm4xenRrUE4zOWtaSWNiSU9uYWpqYVU4TklQVkxHVzd3TlViZHRzb1Y4eEhzQV9zWlZDdkZYdTFkaFAyaHRwekFtUUVhN295WUthWE55TXZzcUFIV0xERnk4dXJrbGYyOEJCNXhnQk1nYkRlODJPQV9zbldNSnBRTGhYYXJPV2VBcGl6Y2xsSkZoT1kzeGtiMmhyTXZQOFktalBtd1ViTzJhd1FRbUU0dWo3dUVtY0NEbGNNQkM1aXZuVXVic2lFLVRBQnd6MXhscGJULVFES2l2ZUowcWxWV3JSUHQ4YnRjcXFVbzdkd0hpanVkTjdPMzVNc1lHVGlxQmduUGloU2ZzWWVPdEpWRjdMUm1GYzFaVDlUUExrODZvQksyRjJ1SkpzNFJ6TDZLU2ZCYjVKY2liRmVXNGsxenNaYW5WbXhBTU1MaEU0bTFTS0VYZ1cwTUNNWVhSektGcW1PMkk2eEdfRENJPQ==)
        KEYSTORE_PATH: '/tmp/keystore.keystore'
        KEYSTORE_PASSWORD: Encrypted(Z0FBQUFBQmhLUFlfOENUZFZvOFNnWEhpQUhLYVJGMlVvMlE4cXI0LXV6VFFzUFp3b1I4c3pOTjNncmJDRVVNamUxLVFqRld5ZGFXaEpyaUhfR1o3ZGtBOVJEcjBleVVCR1E9PQ==)
        KEY_ALIAS_PASSWORD: Encrypted(Z0FBQUFBQmhLUFlfOENUZFZvOFNnWEhpQUhLYVJGMlVvMlE4cXI0LXV6VFFzUFp3b1I4c3pOTjNncmJDRVVNamUxLVFqRld5ZGFXaEpyaUhfR1o3ZGtBOVJEcjBleVVCR1E9PQ==)
        KEY_ALIAS: Encrypted(Z0FBQUFBQmhLUFlfOENUZFZvOFNnWEhpQUhLYVJGMlVvMlE4cXI0LXV6VFFzUFp3b1I4c3pOTjNncmJDRVVNamUxLVFqRld5ZGFXaEpyaUhfR1o3ZGtBOVJEcjBleVVCR1E9PQ==)
      xcode: 12.4
      node: 12
      npm: 6
    cache:
      cache_paths:
        - $FCI_BUILD_DIR/node_modules
    scripts:
      - name: Install dependencies
        script: |
          npm install
          npm ci
          cvm install 9.0.0
          cvm use 9.0.0                  
      - name: Add Android platform
        script: |
          set -x
          cordova platform remove android --nosave
          cordova platform add android --confirm --no-interactive --noresources          
      - name: Build Android
        script: |
          set -x
          set -e
          cordova build android --release --no-interactive --prod --device
          echo $KEYSTORE | base64 --decode > $KEYSTORE_PATH
          UNSIGNED_APK_PATH=$(find platforms/android/app/build/outputs -name "*.apk" | head -1)
          jarsigner -sigalg SHA1withRSA -digestalg SHA1 -keystore "${KEYSTORE_PATH}" -storepass "${KEYSTORE_PASSWORD}" -keypass "${KEY_ALIAS_PASSWORD}" "${UNSIGNED_APK_PATH}" "${KEY_ALIAS}"
          mv $UNSIGNED_APK_PATH $(echo $UNSIGNED_APK_PATH | sed 's/-unsigned//')          
    artifacts:
      - platforms/android/app/build/outputs/**/*.apk
      - platforms/android/app/build/outputs/**/mapping.txt
    publishing:
      # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
      email:
        recipients:
          - kalgi@nevercode.io
        notify:
          success: true     # To receive a notification when a build succeeds
          failure: false    # To not receive a notification when a build fails
