workflows:
  android-workflow:
    name: Android Cordova workflow
    environment:
      vars:
        KEYSTORE: Encrypted(Z0FBQUFBQmhLUHJRWG5haFVzMjZOcnJPSDFFWmtZclR4bUppRVlhbzdNZlVMZXJMajFWaktOQm1mWU9IRVhobEJtTU9Ua0p0MExtc01LNWFtbWhqMjRWOWIzQ1BWVHpmc1JqWE9SNWxIbHpSVVAzbGUwQTNyem5YVjlKbnFqX3o4UkJmbXlzdjVoeWZMUy1LUkxpSC1fT0xod0NsaFZWeHBGRlk4OVc1c1c1cUN4RmpzVURud1Nna3pDanJJekdZcFROU3BDSUladzhRT1NiZk5QdzBqVDcxMEEtT001QjFCbGotdHpOdVc5czZ4RUFyOXpMcHpWNW9NRTJJcTBtNzlRU3MxbTM0NzFKU1RYeXlXSW1YWGVmUWxMdFk0aDF2emxyUkZuUW03aFdQTGdTckVBTllEOXhfR3F1dXNqZmJpMHZJdE53TmJKYXBIQTJOZVB6MklHaDJoZWprUndyeUxFVFJXbWZ6ZlA1S1R0bmhkY1pyU3NKRURVTXN3M0dsVjNkX1hZaVVNMm8tU2NpYVluYmQtQnpoWnRtTHgwT1VuMnJGX25ycUcxdW84TjNEMGV6dzRZSmp4U2JuNWl6UkVRLXJfU2ZkUEZ4dXczRVVpOFJwQ01yWFQ5TjhYTXpFMGZCRE5wM1k3VmZWN094aGgwamhORlBZWEZxVWd5ZVBPcG5TUnc1b3NnSHFDYXJIZUNBSE1DX1BST1RxcEtMc09rb2x0MUR3STd0RDRSMDI3eUo0MzB4ekRIR2hzZUl5N2R6ODlaQUFpY2xtNEVyUXdiSjdYUGZTTS0zOUgwVGV5cHo0dHloS1pJbC02Rm9DVm92aGUyaXVNbi1BQTNHWHM0R1N6UENRaENNZERtZXc4QUpwaWFiM29EbHpuY29VNjNKd241MkFjZDVSVVRyWmlyZmdvQ3c1bGNsQ1psMnZVY2otdHB1UzN0YnI1U2pKWXdqTVhvSGhJYzdoTlJUOFgwdjk5MFp1TTE5WXBsVU1vejM3N2l5anUzTlNqLU1lRE1tMGF4TTE3VzJFOHNreHhCbnBldVdjNUxzNXg3SERpZ2NqdjNmeVBRaTRvRjBsZVFzcmlZeGlRem55OW4yemVKOUhISjZCS2xIUTNrcnNhZWEyNW5TNWpyY0phZ21LQWE5SzZzeWRNM1ZHQ1RmOGp5ZGF2UjVWZ3JpWThQTWg2ZlJPdlA5WEdpZVljMm9kSGtjUTFjVHo1SjBPVzlMWVRPd001MHBCdnpQQ2VHUHpGUlFRYU9IN0pjSzBnaERYS3ZuUVlQOTljWnpkY21kbEE0ai1uME9SZlVxSmJxNnZxSWJLemRJOWgyMHBGZTczT2lpZTZHcjdBS3VBR2lSTVVaSHlVcDZjcldibWxOYnZZdFE5VUQzcmlkYjI5SE5yYlo3blQ2a2ZyMVdjR0xRcjhKU3VzMHdyamVDZFAwVjMwQk1QSU9FODRCU3hqZVdmaGNvZVFzaXQ5ZTh5VkVKSGNEbnFwTzlwOFNsdGZJaC1UT2FJQmNrd0R4cktwR2drM3ZPakJ3Wm1DYU5ZY0hiRXhKYkFqZ3liN0ZZRUJ1NGYzVUJnaE13LU9nZ00tbDFiR3YxeHltcGRVdXZiNXdCTk5fRUQxbV9Ld0xwcFFCVlZsVGVlMWxWVzBFdk9Ic250aXdXYUROSDRQdVFLZXhlYmhTVDUzNU85REFkYy1Gc2UwLWdObUg0Q2dMS2tGRXNiVTVLbmozdnFPbjRneTVmcEdpZW95Uk5xQ3JnQjNJLUxMU0RfR25ob0VISXVxMmtzMGEtSTBUc0RkSFRzdGF2eVVSb0daMjhiTm1kRlFCekJnSGZkdmtuREpzOVVnNmgyTDVKX2ZPZmFRUDY2bjhJQjhSWFo0cEszYjZ1YXlSSW9HUmVQaXVqQ3hHdW5Ma1FLN3BReWtGUXVueU5pT3hDbEtEWWN0UGZlM1ZUUk5BeDR0OEJMdFJHNHFubTVPTlBRQkp5bXFqWFpWUlRveFkyQ21kaUpHeWViUGQ2a21YLXhzYk1NNTNDbnJibUgyeHhZMmJDeUtVb1FtckVuOEYyMjY0VS1HT01penh0MVBNRTdNdHgyR1hla2VvRVBnaEp4TEF3clNLcGZvbUtnZkgxM25jS1FpaXVlTmt5ckZQSDgxRVJqbnVFMVdQZXloSmFraUdsS0JTOGJmVVdrdkFqa0RlTzJseGlFYnJzX1hZVmpkS2lRazBpVnloUGk3ZmJadUdIR0FhQml3ZE5UdzVMWjd5SUhNVXVQSlFzTUFxMk5RZ0dBazhvOVhFR0ZTaXFON0dvZkFJQ0FqNXlnNzVVRDFRS2N0WlI3WDJwczBib1hBU3VMT0Utdkhya0NkclZBbklxeFdLWWp0SHFKajlzMmxTTEtBTGVHb3NXMmdkbDlqWVdVX0tZZUNBMWJ3eC11dGdURExfcjJuanJNdnMycGg0NWlDaTBpMW1CdXQ3YlVGd1NsV0ptSFNUclU3eU9aOW9KdURDeFl2cGdGMG1jR182c2UxUWVZNXpudC00RWJTMFdrZ25oZ1pNVUhFSXV5cHoxak9CMUkyOHpIdXBubGl3SEVDdWdFaU05Tnk2QzdOZlZBVElrQkMxa3pST0pwcUVFelZBLTVxbnhDVzdMVWw3dHR1VThjVk5jdjc1UW5JSlhOR1Q4SkYtY0paSnc0VENXcHllVUdlc2pGRXNjam9qQ214eXRURDNMWlNGTjdiLXpBWV9hTGpmdDFVdDZjSXcxc1NKWjJsZGdMY0xUUU1nYmdBWElDMlYxMjJnNlFMYzZ0MTlTU2pscFNIR1V6bXdVeDc1U1VkUUNGQUI5cEZWRXZnWUhwTkJoZWlHVXZ0aFVGTlM4anFHcm5rUHd3TGdvMTBrY05sRnJaVW5nRU8xMXFxaDRDMVRicFM4QXNFNnVxT0lRWU5UbmVCMkhlVVV0SnJsRXdPaXVPVlJGdU1aSlkzUl9tbHVZajRDUVRITGtETm8wNy0tSi05ZlEyNjlSMHBSSWlxeGV3RjhuVW1OSGIyOGdhd181NmFuZnNrODR6UlRPbkpLZWhjX25EakYzQkJEWDRqMVA2SDBHRW1WTm84VTNiX1ppZUN2ZjhyZEFnV0pkTWxPaVhZNllxVjFvajhEWVlhTWhEWTJxcTVaMUJxcUFRdElHMXY5M2xMbE8xaXIwek5US1hEYW9oaWFCVFZPeDFKRnppdHRCZWV5MkZ2cVRXZkU5M2s3T0puaGpuZXFBM0dodjBReWlqamktZ1Vad1pBYTNaTTFaeE16UUpJX0tYZ2dULTE2YTgxbWg5RlJFYkNkY3RkbGJYdDMyVWw5NnU0YUJJWnVHYkhnOHZ1dnpPa3hmS0dnMU9hdFNDNklyREtwallBU09HWjBVbHlobUwyMHU2NFhiaTZsYUxsb2RPYm92WWNhVGdWQUdhN096QllHcTlRVHR2dDhJU1Z2YnFhNE9FYVlkRjlqbXcxdnZyUkNDZDdJT01lWU8zTEJyd2swbTQySVF0Z3lubGhzRHBrSzRldnBfcEZaZ0tYY08tTnVuZlk3UVF6NXRXSWNfWnN2Rkg1YWdBVDZUTUZWOHFwTXlIUkhTVWsyTzloZXBBc0xIem5OSWdETmhaUDZvSGZuNjU4SnBrUXZrcVNoNkdGeGF6UldZZDlkeXh4ZTJmZGY4bVp5UjZBbC10SkxKQWlULXlVUlVpa1JYZ1p6RE5FSk9kTmN3ZXlPc1JzNXZUeTVVM1N3ZUg5a2J6WlBhbnc0SF9yak0yUFpEYkhEMUp5X1FQMXoyekljcVZULVRPS2VKaTZia0VkZGtnSnM5R2F1dVRMdVBJUkN0bWEzcGdzc2o0eW5QVEd3cGJZNXRtT1FzRlU0QzRfVkJVMEgtTWczVzRrZjh0R3RDLVlSSlNQTVlEdno0LVRkYVluNVNCMThTWkVMMlBpbTBVa2ZHQzVoWVhmakhrbTBNU3NkSDc4bXBGRDlsU1kwUXJuS2FoYlFmU2I2WEJCcl9JaEwySF9LWG0tWlVzVG5JZlRYTjJSeHhoVWtleEJlN3hWOGlYc2F0ZXpmWE1iXzZrQnJWSm5DV3lKVkJLbWVUNFZmam9xUUhXcW5JZ243MFFhSnFmTGlhN0Iwb0lXYU5BMUtjenhtdGNDakdRQnlaSHo3VWVxcGlKeElxNC1qaUk2djdSU1RZQzRBV3JNNXhOLThwSkJVTjhGTXVPZklha2VJeTdBenVaVWhSQmxjWU1Ubms0akJPcy0zRzNPWXBWc2g3SGdiY0lCQUFFRHM1NzNta09XZDVyUDl1elJ4RFdsSlozODg3b3NHVjg3UnhYRzB4elVnMXcwcUlGNmVONjVnckVkNlh4dW9IaFdpdl9NclVSb1huTVFnNjJ0ZkZBalh4OGdIaXZNU1haSXlGTlRWanowSm5rQXZhekR3MFB5cEUtVXRWQU8wRmNRakxPalN6LTJ2Y0p4cVhZLUtUUy1oeEFzUUw2UmVEMk5Fd3JIOHdGMDZJM3BpcFVGX1NDRXI0c1RkdmpzNFFZeDZNbUg3Mkpic29aU3VfWnNoajB3NHJXanlWcld6dzBYNjJnRmVDTVpzZVduVndrOEg1bURGNUF2UHVhaUNWa1d2a2laSHJjYnAwV2NhUjAzWTFPSFRob0V3RWpFVGY3UXc1emNJc01NSGgwYkd1YmZxNHRrMXRnSE1DREVIOFBPTlNNYkF3UVEzSzdyM0lSMl91M3FoWW1aUDNvbjRwZEY1dEFIWE9yWnZnMVFmU1Q4bDVZSWQ1RDg5U3B0a0hmQUk5bjVJakJVNHdiYWVxeWVHRDM5VElEU0ItUUhwRjFlcHNEcDA0eFNNRmRLaEMtMUtyejZhamlYeGQ4NGxhanBvVDF0NjdJT0ZCMTBTVFJtSGlyVjdWaHFNbWo0S2dQOUluZlZsMlZ4Z04xejZPTmZLZFhmUkl1QnFaTVR5amh6WFB2eDNVLWZtT0ctU1N1WFM4aGMzNE5GZTVsdnRzdnFKNE9pN0djNGlfRjlrVjEwZ3FqMzZBV3FQeHNSWV9iRldZUFhBVGxYNXJ2T1dOYWI3QWd3cEZBN2tqY01Ddi15YnNSRVZ2cldNcWJFeUVocU1TNWtGRzkzZWlnV2xXM1BvRDVRV0tiNUlDNEtjMDJzMHg1YXJjcnRnRFI0UU1nT0ZiWndhTnV5VkluQ0QwZlZnY0hKY1Uwcm5YVDdBb1VwRVluTnlhODhEU29JNG0yenp5V0F3T2tLZHVmVUI3UFlnazhNcDl1U05qMjU2dV9tOVNrMVdaem0zZ00xVk15ZXVBQjI0cDh3eVFaOVhObmJrVUhVZFotTHpYS1h1TzcxUkNteFhBPQ==)
        KEYSTORE_PATH: '/tmp/keystore.keystore'
        KEYSTORE_PASSWORD: Encrypted(Z0FBQUFBQmhLUHNFY0NqZExBUFdsbk5STTRCeDlxWEpObmRDT0JlMlBBS19Qc1R0ZDRYMy1VaFhVaWl4eDAwRzBRNzN3MGxHaDRQVWxOcUhmdmxOVEl2WEJrRllKV192OGc9PQ==)
        KEY_ALIAS_PASSWORD: Encrypted(Z0FBQUFBQmhLUHNFY0NqZExBUFdsbk5STTRCeDlxWEpObmRDT0JlMlBBS19Qc1R0ZDRYMy1VaFhVaWl4eDAwRzBRNzN3MGxHaDRQVWxOcUhmdmxOVEl2WEJrRllKV192OGc9PQ==)
        KEY_ALIAS: Encrypted(Z0FBQUFBQmhLUHNFY0NqZExBUFdsbk5STTRCeDlxWEpObmRDT0JlMlBBS19Qc1R0ZDRYMy1VaFhVaWl4eDAwRzBRNzN3MGxHaDRQVWxOcUhmdmxOVEl2WEJrRllKV192OGc9PQ==)
      xcode: 12.4
      node: 12
      npm: 6
    cache:
      cache_paths:
        - ~/.node_modules
    scripts:
      - name: Install dependencies
        script: |
          npm install
          npm ci
          cvm install 9.0.0
          cvm use 9.0.0                  
      - name: Add Android platform
        script: |
          set -x
          cordova platform remove android --nosave
          cordova platform add android --confirm --no-interactive --noresources          
      - name: Build Android
        script: |
          set -x
          set -e
          cordova build android --release --no-interactive --prod --device
          echo $KEYSTORE | base64 --decode > $KEYSTORE_PATH
          UNSIGNED_UNALIGNED_APK_PATH=$(find platforms/android/app/build/outputs -name "*.apk" | head -1)
          UNSIGNED_APK_PATH=$(echo $UNSIGNED_UNALIGNED_APK_PATH | sed 's/-unsigned/-unsigned-aligned/')
          SIGNED_APK_PATH=$(echo $UNSIGNED_APK_PATH | sed 's/-unsigned-aligned//')
          zipalign -v -p 4 $UNSIGNED_UNALIGNED_APK_PATH $UNSIGNED_APK_PATH
          apksigner sign --ks $KEYSTORE_PATH --ks-pass pass:$KEYSTORE_PASSWORD --ks-key-alias $KEY_ALIAS --key-pass pass:$KEYSTORE_PASSWORD --in $UNSIGNED_APK_PATH --out $SIGNED_APK_PATH
          rm -rf $UNSIGNED_UNALIGNED_APK_PATH
          rm -rf $UNSIGNED_APK_PATH
    artifacts:
      - platforms/android/app/build/outputs/**/*.apk
      - platforms/android/app/build/outputs/**/mapping.txt
    publishing:
      # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
      email:
        recipients:
          - kalgi@nevercode.io
        notify:
          success: true     # To receive a notification when a build succeeds
          failure: false    # To not receive a notification when a build fails
